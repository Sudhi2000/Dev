<div class="container-fluid">
  <div class="row">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body">
          <div class="container-fluid d-flex justify-content-between header">
            <div class="col-lg-8 ps-0">
              <a routerLink="." class="nobleui-logo d-block mt-3">Hazard & Risk<span>
                  Management</span></a>
              <h6 class="  pb-4"># {{generalForm.value.reference_number}}</h6>
            </div>
            <div class="col-lg-4 pe-0">
              <h6 class="fw-bold text-end mt-4 mb-2">Reported Date</h6>
              <h6 class="text-end mb-5 pb-4">{{generalForm.value.reported_date| date:'MMM d, y'}}</h6>
            </div>
          </div>
          <div class="container-fluid  d-flex justify-content-center w-100">
            <div class="table-responsive w-100">
              <div class="row ">
                <mat-tab-group mat-align-tabs="start">
                  <mat-tab [formGroup]="generalForm">
                    <ng-template mat-tab-label>
                      <mat-icon class="example-tab-icon">article</mat-icon>
                      Hazard / Risk Details
                    </ng-template>
                    <div class="row ">
                      <div class="col-md-6">
                        <mat-form-field appearance="outline">
                          <mat-label>Category</mat-label>
                          <input type="text" formControlName="category" matInput>
                          <mat-error>Required Field</mat-error>
                        </mat-form-field>
                      </div>
                      <div class="col-md-6">
                        <mat-form-field appearance="outline">
                          <mat-label>Sub Category</mat-label>
                          <input type="text" formControlName="sub_category" matInput>
                          <mat-error>Required Field</mat-error>
                        </mat-form-field>
                      </div>
                    </div>
                    <div class="row">
                      <div *ngIf="generalForm.controls['observation'].value" class="col-md-12">
                        <div class="selected-observation">
                          <strong>Observation:</strong> {{ generalForm.controls['observation'].value }}
                        </div>
                      </div>
                    </div>
                    <div class="row ">
                      <div class="col-md-6">
                        <mat-form-field appearance="outline">
                          <mat-label>Division</mat-label>
                          <input type="text" formControlName="division" matInput>
                          <mat-error>Required Field</mat-error>
                        </mat-form-field>
                      </div>
                      <div class="col-md-6">
                        <mat-form-field appearance="outline">
                          <mat-label>Location / Department</mat-label>
                          <input type="text" formControlName="location_department" matInput>
                          <mat-error>Required Field</mat-error>
                        </mat-form-field>
                      </div>
                    </div>
                    <div class="row ">
                      <div class="col-md-6">
                        <mat-form-field appearance="outline">
                          <mat-label>Sub Location</mat-label>
                          <input type="text" formControlName="sub_location" matInput>
                          <mat-error>Required Field</mat-error>
                        </mat-form-field>
                      </div>
                    </div>
                    <div class="row mb-4">
                      <quill-editor placeholder="Description" [modules]="quillConfig" formControlName="description">
                      </quill-editor>
                    </div>
                    <div class="row">
                      <h6 class="mb-3">Evidence</h6>
                    </div>
                    <div class="row image">
                      <a href="" (click)="false" class="col-md-2 ps-1 pe-1"
                        *ngFor="let image of evidences; let i=index">
                        <figure class="mb-2">
                          <img class="img-fluid rounded" [src]="image.src" (click)="open(i)" width="150" alt="">
                        </figure>
                      </a>
                    </div>

                    <div class="row">
                      <h6 class="mb-3">More Evidences</h6>
                    </div>

                    <div class="row image">
                      <a href="" (click)="false" class="col-md-2 ps-1 pe-1"
                        *ngFor="let image of moreFiles; let i=index">
                        <figure class="mb-2">
                          <img class="img-fluid rounded" [src]="image.src" (click)="openMore(i)" width="150" alt="">
                        </figure>
                      </a>
                    </div>
                  </mat-tab>
                  <mat-tab [formGroup]="resolutionForm">
                    <ng-template mat-tab-label>
                      <mat-icon class="example-tab-icon">bolt</mat-icon>
                      Resolution Details
                    </ng-template>
                    <div class="row mb-1">
                      <div class="col-md-6">
                        <mat-form-field fxFlex appearance="outline">
                          <mat-label>Control</mat-label>
                          <mat-select formControlName="control" (selectionChange)="chatGPT()">
                            <mat-option *ngFor="let control of controls" [value]="control.attributes.Value">
                              {{control.attributes.Value}}</mat-option>
                          </mat-select>
                          <mat-error>Required field</mat-error>
                        </mat-form-field>
                      </div>
                      <div class="col-md-6">
                        <mat-form-field appearance="outline">
                          <mat-label>Cost</mat-label>
                          <input type="text" matInput placeholder="Please provide the cost" formControlName="costVal"
                            (change)="cost($event)" OnlyNumber="true">
                          <mat-error *ngIf="resolutionForm.controls.cost.errors?.['pattern']">Given value is not
                            acceptable</mat-error>
                          <mat-error *ngIf="resolutionForm.controls.cost.errors?.['required']">Required field
                          </mat-error>
                        </mat-form-field>
                      </div>
                    </div>
                    <div class="row mb-2 hide" id="ai-loader">
                      <button class="btn btn-success" type="button">
                        <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
                        Please wait our AI is looking into the actions has to taken care.
                      </button>

                    </div>
                    <div class="row mb-5">
                      <quill-editor placeholder="Action taken" [modules]="quillConfig" formControlName="action_taken">
                      </quill-editor>
                    </div>
                    <div class="row mb-5">
                      <quill-editor placeholder="Remarks *" [modules]="quillConfig" formControlName="remarks">
                      </quill-editor>
                      <p *ngIf="!resolutionForm.controls['remarks'].valid &&resolutionForm.controls['remarks'].touched"
                        class="quill-editor-error"> Required Field *</p>
                    </div>

                    <div class="row mt-3 " *ngIf="actionForm.value.status==='In-Progress'">
                      <div class="custom-dropzone" ngx-dropzone [accept]="'image/*'" (change)="onSelect($event)">
                        <ngx-dropzone-label>Drop your evidences here. Please ensure the image
                          size is less than 2 MB</ngx-dropzone-label>
                        <ngx-dropzone-image-preview ngProjectAs="ngx-dropzone-preview" [removable]="true"
                          *ngFor="let f of files; let i = index;" [file]="f" (removed)="onRemove(f,i)">
                        </ngx-dropzone-image-preview>
                      </div>
                      <p *ngIf="!resolutionForm.controls['evidence'].valid" class="warning-font-size">
                        Required Field *</p>
                    </div>

                    <div class="form-check form-switch mb-3 mt-3" *ngIf="addMoreEvidence">
                      <input type="checkbox" class="form-check-input" id="formSwitch1"
                        formControlName="add_more_evidence">
                      <label class="form-check-label" for="formSwitch1">Add more evidence</label>
                    </div>

                    <div class="row mt-3" *ngIf="resolutionForm.value.add_more_evidence">
                      <div class="custom-dropzone" ngx-dropzone [accept]="'image/*'"
                        (change)="onSelectMoreEvidence($event)">
                        <ngx-dropzone-label>Drop more evidences here. Please ensure the image
                          size is less than 10 MB</ngx-dropzone-label>
                        <ngx-dropzone-image-preview ngProjectAs="ngx-dropzone-preview" [removable]="true"
                          *ngFor="let f of moreFilesAfter; let i = index;" [file]="f"
                          (removed)="onRemoveMoreEvidence(f,i)">
                        </ngx-dropzone-image-preview>
                      </div>
                    </div>
                    <!-- <div class="mb-3" *ngIf="actionForm.value.status !== 'Open'">
                      <label class="btn btn-secondary btn-icon-text">
                          <input type="file" (change)="handleFileInput($event)"/>
                          <i class="feather icon-paperclip btn-icon-prepend"></i> Attach Evidence
                      </label>
                  </div>
                    <div class="mb-3">
                      <img [src]="resolutionForm.value.evidence" class="evidenceImg">
                    </div> -->
                    <div class="mb-3" *ngIf="actionForm.value.status==='In-Progress'">
                      <button type="button" class="btn btn-primary btn-icon-text float-end mt-4 mr-5" (click)="submit()"
                        *ngIf="!rejectForm.get('reject_reason')?.value">
                        <i class="feather icon-send btn-icon-prepend"></i>
                        Save
                      </button>
                    </div>
                  </mat-tab>
                  <mat-tab [formGroup]="rejectForm" *ngIf="rejectForm.get('reject_reason')?.value">

                    <ng-template mat-tab-label>
                      <mat-icon class="example-tab-icon">bolt</mat-icon>
                      Rejection Details
                    </ng-template>

                    <div class="row">
                      <h6 class="mb-3">Rejection reason</h6>
                    </div>

                    <div class="row mb-5">
                      <quill-editor placeholder="Reject Reason" [modules]="quillConfig" formControlName="reject_reason">
                      </quill-editor>
                    </div>
                    <div class="row">
                      <h6 class="mb-3">Rework Description *</h6>
                    </div>
                    <div class="row mb-5">
                      <quill-editor placeholder="Remarks *" [modules]="quillConfig"
                        formControlName="rework_description">
                      </quill-editor>
                      <p *ngIf="!rejectForm.controls['rework_description'].valid &&rejectForm.controls['rework_description'].touched"
                        class="quill-editor-error"> Required Field *</p>
                    </div>
                    <!-- <div class="mb-3" *ngIf="actionForm.value.status !== 'Open'">
                      <label class="btn btn-secondary btn-icon-text">
                          <input type="file" (change)="handleFileInput($event)"/>
                          <i class="feather icon-paperclip btn-icon-prepend"></i> Attach Evidence
                      </label>
                  </div>
                    <div class="mb-3">
                      <img [src]="resolutionForm.value.evidence" class="evidenceImg">
                    </div> -->
                    <div class="mb-3" *ngIf="actionForm.value.status==='In-Progress'">
                      <button type="button" class="btn btn-primary btn-icon-text float-end mt-4 mr-5"
                        (click)="submit()">
                        <i class="feather icon-send btn-icon-prepend"></i>
                        Save
                      </button>
                    </div>
                  </mat-tab>
                </mat-tab-group>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card">
        <div class="card-body" [formGroup]="actionForm">
          <div class="mt-3 d-flex ">
            <button [disabled]="actionForm.value.status==='Completed'" class="btn btn-primary" mat-icon-button
              [matMenuTriggerFor]="menu" aria-label="Example icon-button with a menu">
              {{actionForm.value.status}}
              <i class="feather icon-chevron-down"></i>
            </button>
            <mat-menu #menu="matMenu">
              <button *ngIf="actionForm.value.status=='Open'||actionForm.value.status==='Rejected'" mat-menu-item
                (click)="in_progress()">
                <span>In-Progress</span>
              </button>
              <button *ngIf="actionForm.value.status=='In-Progress'" mat-menu-item (click)="completed()">
                <span>Completed</span>
              </button>
            </mat-menu>
            <button (click)="navigate()" class="btn btn-success status-btn ms-1" mat-icon-button
              aria-label="Example icon-button with a menu">
              <i class="feather icon-chevron-left"></i> Back to History

            </button>
          </div>
          <div class="mt-3">
            <label class="tx-11 fw-bolder mb-0 text-uppercase">Reported By:</label>
            <p class="text-muted">{{actionForm.value.reporterName?actionForm.value.reporterName:actionForm.value.extReporterName}}, {{actionForm.value.reporterDesignation?actionForm.value.reporterDesignation:actionForm.value.ext_reporter_employee_id}}</p>
          </div>

          <div class="mt-3">
            <label class="tx-11 fw-bolder mb-0 text-uppercase">Responsible :</label>
            <p class="text-muted">{{actionForm.value.responsible_person}}, {{actionForm.value.responsible_deignation}}
            </p>
          </div>
          <div class="mt-3">
            <label class="tx-11 fw-bolder mb-0 text-uppercase">Risk Level:</label><br>
            <mat-button-toggle-group name="fontStyle" aria-label="Font Style" formControlName="level">
              <mat-button-toggle value="High">High</mat-button-toggle>
              <mat-button-toggle value="Medium">Medium</mat-button-toggle>
              <mat-button-toggle value="Low">Low</mat-button-toggle>
            </mat-button-toggle-group>
          </div>
          <div class="mt-3">
            <label class="tx-11 fw-bolder mb-0 text-uppercase"></label><br>
            <mat-button-toggle-group name="fontStyle" aria-label="Font Style" formControlName="unsafe"
              #group="matButtonToggleGroup">
              <mat-button-toggle value="Unsafe Act">Unsafe Act</mat-button-toggle>
              <mat-button-toggle value="Unsafe Condition">Unsafe Condition</mat-button-toggle>
            </mat-button-toggle-group>
          </div>
          <div class="mt-3">
            <mat-form-field appearance="outline" color="primary">
              <mat-label>Due Date</mat-label>
              <input matInput [matDatepicker]="dp" [formControl]="duedate">
              <mat-datepicker-toggle matSuffix [for]="dp"></mat-datepicker-toggle>
              <mat-datepicker #dp></mat-datepicker>
            </mat-form-field>
            <!-- <mat-form-field appearance="outline" color="primary">
              <mat-label>Targeted Completion Date:</mat-label>
              <input matInput [matDatepicker]="targeteddate" [formControl]="targetedDate"
                (dateChange)="targetdate($event)" [min]="minDate" [max]="coolPeriod">
              <mat-datepicker-toggle matSuffix [for]="targeteddate"></mat-datepicker-toggle>
              <mat-datepicker #targeteddate></mat-datepicker>
              <mat-error>Required field</mat-error>
            </mat-form-field> -->
            <mat-form-field appearance="outline" color="primary">
              <mat-label>Targeted Completion Date:</mat-label>
              <input matInput [matDatepicker]="targeteddate" [formControl]="targetedDate"
                (dateChange)="targetdate($event)" [min]="minDate" [max]="dueDate">
              <mat-datepicker-toggle matSuffix [for]="targeteddate"></mat-datepicker-toggle>
              <mat-datepicker #targeteddate></mat-datepicker>
              <mat-error *ngIf="targetedDate.hasError('required')">Required field</mat-error>
            </mat-form-field>
            <mat-form-field appearance="outline" color="primary">
              <mat-label>Completed Date:</mat-label>
              <input matInput [matDatepicker]="completeddate" [formControl]="completedDate"
                (dateChange)="completeDate($event)" [min]="minDate">
              <mat-datepicker-toggle matSuffix [for]="completeddate"></mat-datepicker-toggle>
              <mat-datepicker #completeddate></mat-datepicker>
              <mat-error>Required field</mat-error>
            </mat-form-field>
            <mat-form-field  *ngIf="externalReporter===true" fxFlex appearance="outline" color="primary">
              <mat-label>HSE Head</mat-label>
              <mat-select formControlName="hse_head" >
                <mat-option *ngFor="let head of hseHeads" [value]="head.id">
                  <img style="vertical-align:middle; margin-right: 4px;"
                    src={{head?.attributes?.image?.data?.attributes?.image}} height="30" />
                  <span>{{ head.attributes.first_name }} {{head.attributes.last_name}}</span>
                </mat-option>
              </mat-select>
              <mat-error>Required Field</mat-error>
            </mat-form-field>
            <mat-form-field fxFlex appearance="outline" color="primary">
              <mat-label>Deligate</mat-label>
              <mat-select formControlName="deligate" (selectionChange)="deligate($event)">
                <mat-option *ngFor="let deligate of deligates" [value]="deligate.id">
                  <img style="vertical-align:middle; margin-right: 4px;"
                    src={{deligate?.attributes?.image?.data?.attributes?.image}} height="30" />
                  <span>{{ deligate.attributes.first_name }} {{deligate.attributes.last_name}}</span>
                </mat-option>
              </mat-select>
              <mat-error>Required Field</mat-error>
            </mat-form-field>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>